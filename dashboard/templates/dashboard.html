<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rari Trade AI - Aster Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 2px solid #ff6b35;
        }

        .card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #3d3d3d;
            border-bottom: 1px solid #555;
            color: #ff6b35;
            font-weight: bold;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #bbb;
            margin-top: 5px;
        }

        .status-online {
            color: #4CAF50;
        }

        .status-offline {
            color: #f44336;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
        }

        .table {
            color: #fff;
        }

        .table thead th {
            border-bottom: 2px solid #ff6b35;
            color: #ff6b35;
        }

        .price-up {
            color: #4CAF50;
        }

        .price-down {
            color: #f44336;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .log-info {
            color: #4CAF50;
        }

        .log-warning {
            color: #ff9800;
        }

        .log-error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-rocket"></i> Rari Trade AI - Aster Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" onclick="showTab('overview')">Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#adaptation" onclick="showTab('adaptation')">AI Learning</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#positions" onclick="showTab('positions')">Positions</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span id="connection-status" class="badge bg-success me-2">
                        <i class="fas fa-circle"></i> Connected
                    </span>
                    <span id="system-status" class="badge bg-secondary">
                        <i class="fas fa-cog"></i> Initializing
                    </span>
                    <span id="market-regime" class="badge bg-info ms-2">
                        <i class="fas fa-chart-line"></i> Analyzing...
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Tab Content -->
        <div id="overview-tab" class="tab-content active">
            <!-- Control Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-gamepad"></i> Control Panel
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <button id="start-trader" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-play"></i> Start Trading
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="stop-trader" class="btn btn-danger btn-lg w-100">
                                        <i class="fas fa-stop"></i> Stop Trading
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="refresh-data" class="btn btn-secondary btn-lg w-100">
                                        <i class="fas fa-sync"></i> Refresh Data
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center h-100">
                                        <small class="text-muted">
                                            Last update: <span id="last-update">Never</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="portfolio-value">$0.00</div>
                            <div class="metric-label">Portfolio Value</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="available-balance">$0.00</div>
                            <div class="metric-label">Available Balance</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="unrealized-pnl">$0.00</div>
                            <div class="metric-label">Unrealized P&L</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="active-positions">0</div>
                            <div class="metric-label">Active Positions</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Market Data -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i> Market Data
                        </div>
                        <div class="card-body">
                            <div id="market-data" class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Price</th>
                                            <th>24h Change</th>
                                            <th>Volume</th>
                                            <th>Bid</th>
                                            <th>Ask</th>
                                        </tr>
                                    </thead>
                                    <tbody id="market-table-body">
                                        <!-- Market data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-area"></i> Portfolio Performance
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="performance-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- Risk Metrics -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-shield-alt"></i> Risk Metrics
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="sharpe-ratio">0.00</div>
                                        <div class="metric-label">Sharpe Ratio</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="max-drawdown">0.00%</div>
                                        <div class="metric-label">Max Drawdown</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="var-95">0.00%</div>
                                        <div class="metric-label">VaR 95%</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="total-risk">0.00%</div>
                                        <div class="metric-label">Total Risk</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-terminal"></i> System Logs
                        </div>
                        <div class="card-body">
                            <div id="system-logs"
                                style="height: 250px; overflow-y: auto; background-color: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <!-- Logs will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Positions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list"></i> Active Positions & Grids
                        </div>
                        <div class="card-body">
                            <div id="positions-data">
                                <p class="text-muted">No active positions or grids</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Learning Tab -->
            <div id="adaptation-tab" class="tab-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-brain"></i> Real-Time Strategy Adaptation
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-lightbulb"></i>
                                            <strong>AI Learning Mode:</strong> System continuously adapts to current
                                            market conditions
                                            using real-time data. No historical backtesting needed.
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-chart-line"></i> Current Strategy Weights
                                                </h6>
                                                <div id="current-weights">
                                                    <p class="text-muted">Loading strategy weights...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-brain"></i> AI Learning Status
                                                </h6>
                                                <div id="learning-status">
                                                    <p class="text-muted">Monitoring AI adaptation...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button id="force-adaptation" class="btn btn-primary me-2">
                                            <i class="fas fa-sync"></i> Force Strategy Adaptation
                                        </button>
                                        <button id="reset-learning" class="btn btn-warning">
                                            <i class="fas fa-undo"></i> Reset Learning State
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Backtest Results -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line"></i> Backtest Results
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="backtest-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy Metrics -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-trophy"></i> Strategy Performance
                            </div>
                            <div class="card-body">
                                <div id="strategy-metrics">
                                    <p class="text-muted">Run a backtest to see results</p>
                                </div>
                            </div>
                        </div>

                        <!-- Strategy Recommendation -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-lightbulb"></i> AI Recommendation
                            </div>
                            <div class="card-body">
                                <div id="strategy-recommendation">
                                    <p class="text-muted">Compare strategies to get recommendations</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div id="positions-tab" class="tab-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list"></i> Open Positions Management
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button id="refresh-positions" class="btn btn-primary me-2">
                                            <i class="fas fa-sync"></i> Refresh Positions
                                        </button>
                                        <button id="close-all-positions" class="btn btn-danger">
                                            <i class="fas fa-times-circle"></i> Close All Positions
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div id="positions-summary" class="text-muted">
                                            Loading positions...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-table"></i> Current Positions
                            </div>
                            <div class="card-body">
                                <div id="positions-table" class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Side</th>
                                                <th>Size</th>
                                                <th>Entry Price</th>
                                                <th>Current Price</th>
                                                <th>P&L</th>
                                                <th>P&L %</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="positions-tbody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">Loading positions...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Global variables
            let websocket = null;
            let performanceChart = null;
            let backtestChart = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let currentTab = 'overview';

            // Initialize dashboard
            document.addEventListener('DOMContentLoaded', function () {
                initializeDashboard();
                setupEventListeners();
            });

            function initializeDashboard() {
                initializeCharts();
                connectWebSocket();
                loadInitialData();
                loadAdaptiveStatus();
            }

            function initializeCharts() {
                // Performance chart
                const perfCtx = document.getElementById('performance-chart').getContext('2d');
                performanceChart = new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Portfolio Value',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });

                // Backtest chart
                const backtestCtx = document.getElementById('backtest-chart').getContext('2d');
                backtestChart = new Chart(backtestCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Strategy Performance',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            function setupEventListeners() {
                // Overview tab events
                document.getElementById('start-trader').addEventListener('click', startTrader);
                document.getElementById('stop-trader').addEventListener('click', stopTrader);
                document.getElementById('refresh-data').addEventListener('click', loadInitialData);

                // Adaptation tab events
                document.getElementById('force-adaptation').addEventListener('click', forceAdaptation);
                document.getElementById('reset-learning').addEventListener('click', resetLearning);

                // Positions tab events
                document.getElementById('refresh-positions').addEventListener('click', refreshPositions);
                document.getElementById('close-all-positions').addEventListener('click', closeAllPositions);
            }

            function showTab(tabName) {
                // Hide all tabs
                const tabs = document.querySelectorAll('.tab-content');
                tabs.forEach(tab => tab.classList.remove('active'));

                // Show selected tab
                const selectedTab = document.getElementById(tabName + '-tab');
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // Update navigation
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));
                const activeLink = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }

                currentTab = tabName;

                // Load tab-specific data
                if (tabName === 'backtesting') {
                    // Could load backtest history here
                } else if (tabName === 'positions') {
                    refreshPositions();
                }
            }

            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/live-data`;

                websocket = new WebSocket(wsUrl);

                websocket.onopen = function (event) {
                    console.log('WebSocket connected');
                    document.getElementById('connection-status').className = 'badge bg-success';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle"></i> Connected';
                    reconnectAttempts = 0;
                };

                websocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                };

                websocket.onclose = function (event) {
                    console.log('WebSocket disconnected');
                    document.getElementById('connection-status').className = 'badge bg-danger';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                    attemptReconnect();
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('connection-status').className = 'badge bg-warning';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                };
            }

            function attemptReconnect() {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                }
            }

            async function loadInitialData() {
                try {
                    // Load market data
                    const marketResponse = await fetch('/api/market/data');
                    const marketData = await marketResponse.json();
                    updateMarketData(marketData);

                    // Load portfolio data
                    const portfolioResponse = await fetch('/api/portfolio/status');
                    const portfolioData = await portfolioResponse.json();
                    updatePortfolioData(portfolioData);

                    // Load risk metrics
                    const riskResponse = await fetch('/api/risk/metrics');
                    const riskData = await riskResponse.json();
                    updateRiskMetrics(riskData);

                    // Load performance history
                    const performanceResponse = await fetch('/api/performance/history?hours=24');
                    const performanceData = await performanceResponse.json();
                    updatePerformanceChart(performanceData);

                    // Load logs
                    const logsResponse = await fetch('/api/system/logs?lines=20');
                    const logsData = await logsResponse.json();
                    updateSystemLogs(logsData.logs);

                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

                } catch (error) {
                    console.error('Error loading initial data:', error);
                    addLogEntry('ERROR', 'Failed to load initial data: ' + error.message);
                }
            }

            function updateDashboard(data) {
                if (data.portfolio) updatePortfolioData(data.portfolio);
                if (data.market_data) updateMarketData(data.market_data);
                if (data.risk_metrics) updateRiskMetrics(data.risk_metrics);
                if (data.system_status) {
                    document.getElementById('system-status').textContent = data.system_status.toUpperCase();
                }
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            }

            function updateMarketData(data) {
                const tbody = document.getElementById('market-table-body');
                tbody.innerHTML = '';

                if (data.data) {
                    Object.entries(data.data).forEach(([symbol, symbolData]) => {
                        const row = document.createElement('tr');

                        let price = 'N/A';
                        let change = 'N/A';
                        let volume = 'N/A';
                        let bid = 'N/A';
                        let ask = 'N/A';

                        if (symbolData.ticker) {
                            const ticker = symbolData.ticker;
                            price = parseFloat(ticker.lastPrice || ticker.price || 0).toFixed(4);
                            change = parseFloat(ticker.priceChangePercent || 0).toFixed(2);
                            volume = parseFloat(ticker.volume || 0).toLocaleString();
                        }

                        if (symbolData.orderbook) {
                            const ob = symbolData.orderbook;
                            if (ob.bids && ob.bids.length > 0) {
                                bid = parseFloat(ob.bids[0][0]).toFixed(4);
                            }
                            if (ob.asks && ob.asks.length > 0) {
                                ask = parseFloat(ob.asks[0][0]).toFixed(4);
                            }
                        }

                        const changeClass = change !== 'N/A' && parseFloat(change) >= 0 ? 'price-up' : 'price-down';
                        const changeIcon = change !== 'N/A' && parseFloat(change) >= 0 ? '↑' : '↓';

                        row.innerHTML = `
                        <td><strong>${symbol}</strong></td>
                        <td>$${price}</td>
                        <td class="${changeClass}">${changeIcon} ${change}%</td>
                        <td>${volume}</td>
                        <td>$${bid}</td>
                        <td>$${ask}</td>
                    `;

                        tbody.appendChild(row);
                    });
                }
            }

            function updatePortfolioData(data) {
                if (data.error) {
                    console.warn('Portfolio data error:', data.error);
                    return;
                }

                document.getElementById('portfolio-value').textContent = `$${data.total_balance.toLocaleString()}`;
                document.getElementById('available-balance').textContent = `$${data.available_balance.toLocaleString()}`;
                document.getElementById('unrealized-pnl').textContent = `$${data.unrealized_pnl.toLocaleString()}`;
                document.getElementById('active-positions').textContent = data.active_positions || 0;

                // Update positions display
                updatePositionsData(data);
            }

            function updatePositionsData(data) {
                const positionsDiv = document.getElementById('positions-data');

                if (data.active_positions > 0 && data.positions) {
                    let html = '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr>';
                    html += '<th>Symbol</th><th>Size</th><th>Entry Price</th><th>Current P&L</th>';
                    html += '</tr></thead><tbody>';

                    Object.entries(data.positions).forEach(([symbol, position]) => {
                        const pnlClass = position.unrealized_pnl >= 0 ? 'price-up' : 'price-down';
                        html += `<tr>
                        <td>${symbol}</td>
                        <td>${parseFloat(position.size || 0).toFixed(6)}</td>
                        <td>$${parseFloat(position.entry_price || 0).toFixed(4)}</td>
                        <td class="${pnlClass}">$${parseFloat(position.unrealized_pnl || 0).toFixed(2)}</td>
                    </tr>`;
                    });

                    html += '</tbody></table></div>';
                    positionsDiv.innerHTML = html;
                } else {
                    positionsDiv.innerHTML = '<p class="text-muted">No active positions</p>';
                }
            }

            function updateRiskMetrics(data) {
                if (data.error) {
                    console.warn('Risk metrics error:', data.error);
                    return;
                }

                document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
                document.getElementById('max-drawdown').textContent = `${(data.max_drawdown * 100).toFixed(2)}%`;
                document.getElementById('var-95').textContent = `${(data.var_95 * 100).toFixed(2)}%`;
                document.getElementById('total-risk').textContent = `${(data.total_risk * 100).toFixed(2)}%`;
            }

            function updatePerformanceChart(data) {
                if (!performanceChart || !data.timestamps || !data.portfolio_values) {
                    return;
                }

                // Format timestamps for display
                const labels = data.timestamps.map(ts => {
                    const date = new Date(ts);
                    return date.toLocaleTimeString();
                });

                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = data.portfolio_values;
                performanceChart.update();
            }

            function updateSystemLogs(logs) {
                const logsDiv = document.getElementById('system-logs');

                if (logs && logs.length > 0) {
                    logsDiv.innerHTML = logs.map(log => {
                        const levelClass = `log-${log.level.toLowerCase()}`;
                        return `<div class="log-entry ${levelClass}">
                        <small>${new Date(log.timestamp).toLocaleTimeString()}</small>
                        <strong>${log.level}</strong>: ${log.message}
                    </div>`;
                    }).join('');
                } else {
                    logsDiv.innerHTML = '<div class="log-entry log-info">System initialized successfully</div>';
                }

                // Auto-scroll to bottom
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }

            function addLogEntry(level, message) {
                const logsDiv = document.getElementById('system-logs');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level.toLowerCase()}`;
                logEntry.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small>
                <strong>${level}</strong>: ${message}
            `;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }

            async function startTrader() {
                try {
                    const response = await fetch('/api/trader/start', { method: 'POST' });
                    const result = await response.json();

                    if (result.status === 'starting') {
                        addLogEntry('INFO', 'Starting autonomous trader...');
                        document.getElementById('system-status').textContent = 'STARTING';
                        document.getElementById('system-status').className = 'badge bg-warning';
                    } else if (result.error) {
                        addLogEntry('ERROR', 'Failed to start trader: ' + result.error);
                    }
                } catch (error) {
                    addLogEntry('ERROR', 'Failed to start trader: ' + error.message);
                }
            }

            async function runBacktest() {
                const strategy = document.getElementById('backtest-strategy').value;
                const days = document.getElementById('backtest-days').value;
                const symbol = document.getElementById('backtest-symbol').value;

                try {
                    addLogEntry('INFO', `Running ${strategy} backtest for ${symbol} (${days} days)...`);

                    const response = await fetch(`/api/backtest/run?strategy=${strategy}&days=${days}&symbol=${symbol}`);
                    const result = await response.json();

                    if (result.error) {
                        addLogEntry('ERROR', 'Backtest failed: ' + result.error);
                        return;
                    }

                    // Update chart
                    updateBacktestChart(result);

                    // Update metrics
                    updateStrategyMetrics(result);

                    addLogEntry('SUCCESS', `Backtest completed: ${result.total_return.toFixed(2)}% return, Sharpe: ${result.sharpe_ratio.toFixed(2)}`);

                } catch (error) {
                    addLogEntry('ERROR', 'Backtest failed: ' + error.message);
                }
            }

            async function compareStrategies() {
                const days = document.getElementById('backtest-days').value;
                const symbol = document.getElementById('backtest-symbol').value;

                try {
                    addLogEntry('INFO', `Comparing all strategies for ${symbol} (${days} days)...`);

                    const response = await fetch(`/api/backtest/compare?days=${days}&symbol=${symbol}`);
                    const results = await response.json();

                    if (results.error) {
                        addLogEntry('ERROR', 'Strategy comparison failed: ' + results.error);
                        return;
                    }

                    // Update recommendation
                    if (results.recommendation) {
                        const rec = results.recommendation;
                        document.getElementById('strategy-recommendation').innerHTML = `
                        <h5 class="text-warning">${rec.best_strategy.toUpperCase()}</h5>
                        <p>Sharpe Ratio: ${rec.sharpe_ratio.toFixed(2)}</p>
                        <p class="text-muted">${rec.reason}</p>
                    `;
                    }

                    // Update metrics comparison
                    updateStrategyComparison(results);

                    addLogEntry('SUCCESS', 'Strategy comparison completed');

                } catch (error) {
                    addLogEntry('ERROR', 'Strategy comparison failed: ' + error.message);
                }
            }

            async function forceAdaptation() {
                try {
                    addLogEntry('INFO', 'Forcing strategy adaptation based on current market conditions...');

                    const response = await fetch('/api/adaptive/adapt', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        addLogEntry('SUCCESS', 'Strategy adaptation completed');
                        // Refresh the strategy weights display
                        loadAdaptiveStatus();
                    } else {
                        addLogEntry('ERROR', 'Strategy adaptation failed: ' + (result.error || 'Unknown error'));
                    }

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to force adaptation: ' + error.message);
                }
            }

            async function resetLearning() {
                if (!confirm('Are you sure you want to reset the AI learning state? This will clear all learned patterns.')) {
                    return;
                }

                try {
                    addLogEntry('WARNING', 'Resetting AI learning state...');

                    const response = await fetch('/api/adaptive/reset', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        addLogEntry('SUCCESS', 'AI learning state reset');
                        // Refresh displays
                        loadAdaptiveStatus();
                    } else {
                        addLogEntry('ERROR', 'Reset failed: ' + (result.error || 'Unknown error'));
                    }

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to reset learning: ' + error.message);
                }
            }

            async function loadAdaptiveStatus() {
                try {
                    const response = await fetch('/api/adaptive/status');
                    const status = await response.json();

                    // Update strategy weights
                    const weightsDiv = document.getElementById('current-weights');
                    if (status.strategy_weights) {
                        let weightsHtml = '';
                        for (const [strategy, weight] of Object.entries(status.strategy_weights)) {
                            const percentage = (weight * 100).toFixed(1);
                            weightsHtml += `
                            <div class="d-flex justify-content-between mb-1">
                                <span>${strategy.charAt(0).toUpperCase() + strategy.slice(1)}:</span>
                                <span class="badge bg-primary">${percentage}%</span>
                            </div>
                        `;
                        }
                        weightsDiv.innerHTML = weightsHtml;
                    }

                    // Update learning status
                    const learningDiv = document.getElementById('learning-status');
                    learningDiv.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Samples Learned</small>
                            <div class="h5 mb-0">${status.learning_samples || 0}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Model Accuracy</small>
                            <div class="h5 mb-0">${status.model_accuracy ? (status.model_accuracy * 100).toFixed(1) : 0}%</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Active Strategies: ${status.active_strategies ? status.active_strategies.length : 0}</small>
                    </div>
                `;

                } catch (error) {
                    console.error('Failed to load adaptive status:', error);
                }
            }

            async function refreshPositions() {
                try {
                    const response = await fetch('/api/positions/open');
                    const data = await response.json();

                    updatePositionsTable(data.positions || []);
                    updatePositionsSummary(data.positions || []);

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to refresh positions: ' + error.message);
                }
            }

            async function closeAllPositions() {
                if (!confirm('Are you sure you want to close ALL positions? This action cannot be undone.')) {
                    return;
                }

                addLogEntry('WARNING', 'Closing all positions...');

                // This would close all positions
                // For now, just show a message
                addLogEntry('INFO', 'All positions close request submitted');
            }

            async function stopTrader() {
                try {
                    const response = await fetch('/api/trader/stop', { method: 'POST' });
                    const result = await response.json();

                    if (result.status === 'stopped') {
                        addLogEntry('INFO', 'Stopping autonomous trader...');
                        document.getElementById('system-status').textContent = 'STOPPED';
                        document.getElementById('system-status').className = 'badge bg-secondary';
                    } else if (result.error) {
                        addLogEntry('ERROR', 'Failed to stop trader: ' + result.error);
                    }
                } catch (error) {
                    addLogEntry('ERROR', 'Failed to stop trader: ' + error.message);
                }
            }

            // Auto-refresh every 30 seconds as backup
            setInterval(loadInitialData, 30000);
        </script>
</body>

</html>