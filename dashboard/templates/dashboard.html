<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ AsterAI HFT Trader - Ultimate Trading Dashboard</title>

    <!-- Modern UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Enhanced Styles -->
    <link href="/static/enhanced_styles.css" rel="stylesheet">

    <!-- Real-time Updates -->
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);

            ws.onopen = function(event) {
                console.log('ðŸ”— Connected to dashboard websocket');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            };

            ws.onclose = function(event) {
                console.log('ðŸ”Œ Disconnected from dashboard websocket');
                updateConnectionStatus(false);

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.innerHTML = '<i class="fas fa-circle text-success"></i> Live';
                statusEl.className = 'badge bg-success';
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle text-danger"></i> Offline';
                statusEl.className = 'badge bg-danger';
            }
        }

        function handleRealtimeUpdate(data) {
            // Update portfolio metrics
            if (data.portfolio) {
                updatePortfolioMetrics(data.portfolio);
            }

            // Update market data
            if (data.market) {
                updateMarketData(data.market);
            }

            // Update performance charts
            if (data.performance) {
                updatePerformanceCharts(data.performance);
            }

            // Update recent trades
            if (data.trades) {
                updateRecentTrades(data.trades);
            }

            // Update system status
            if (data.system) {
                updateSystemStatus(data.system);
            }
        }

        let portfolioChart = null;
        let performanceData = {
            labels: [],
            datasets: [{
                label: 'Portfolio Value',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4
            }]
        };

        function initializeCharts() {
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: performanceData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0,
                            hoverRadius: 6
                        }
                    }
                }
            });
        }

        function updateChartTimeframe(timeframe) {
            // Update chart timeframe buttons
            document.querySelectorAll('.chart-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // In a real implementation, this would fetch data for the selected timeframe
            console.log('Updating chart to timeframe:', timeframe);
        }

        function setupEventListeners() {
            // Agent selector change
            document.getElementById('agent-selector').addEventListener('change', function(e) {
                switchAgent(e.target.value);
            });

            // Trading controls
            document.getElementById('start-trader').addEventListener('click', startTrading);
            document.getElementById('stop-trader').addEventListener('click', stopTrading);
            document.getElementById('emergency-stop').addEventListener('click', emergencyStop);

            // Risk controls
            document.getElementById('update-risk-limits').addEventListener('click', updateRiskLimits);
        }

        function switchAgent(agentType) {
            const strategyMode = document.getElementById('strategy-mode');
            if (agentType === 'degen') {
                strategyMode.textContent = 'Mode: Degen Trading';
                strategyMode.className = 'badge bg-warning';
                showAlert('Switched to Degen Trading mode - HIGH RISK', 'warning');
            } else {
                strategyMode.textContent = 'Mode: HFT Conservative';
                strategyMode.className = 'badge bg-info';
                showAlert('Switched to Conservative HFT mode', 'info');
            }

            // Send agent switch command to backend
            sendCommand('switch_agent', { agent_type: agentType });
        }

        function startTrading() {
            const btn = document.getElementById('start-trader');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            btn.disabled = true;

            sendCommand('start_trading', {}).then(() => {
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop Trading';
                btn.className = 'btn btn-danger btn-lg w-100';
                btn.id = 'stop-trader';
                btn.disabled = false;
                updateTradingStatus(true);
            });
        }

        function stopTrading() {
            const btn = document.getElementById('stop-trader');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
            btn.disabled = true;

            sendCommand('stop_trading', {}).then(() => {
                btn.innerHTML = '<i class="fas fa-play"></i> Start Trading';
                btn.className = 'btn btn-primary btn-lg w-100';
                btn.id = 'start-trader';
                btn.disabled = false;
                updateTradingStatus(false);
            });
        }

        function emergencyStop() {
            if (confirm('Are you sure you want to emergency stop all trading?')) {
                sendCommand('emergency_stop', {});
                showAlert('Emergency stop activated - all positions closed', 'danger');
            }
        }

        function updateRiskLimits() {
            const maxLoss = document.getElementById('max-daily-loss').value;
            const maxPositions = document.getElementById('max-positions').value;

            sendCommand('update_risk_limits', {
                max_daily_loss: parseFloat(maxLoss),
                max_positions: parseInt(maxPositions)
            });

            showAlert('Risk limits updated successfully', 'success');
        }

        function updatePortfolioMetrics(data) {
            document.getElementById('portfolio-value').textContent = '$' + data.value.toLocaleString();
            document.getElementById('portfolio-change').textContent =
                (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + ' (' + data.changePercent.toFixed(2) + '%)';

            const pnlElement = document.getElementById('daily-pnl');
            pnlElement.textContent = '$' + data.dailyPnl.toFixed(2);
            pnlElement.className = data.dailyPnl >= 0 ? 'metric-value text-success' : 'metric-value text-danger';
        }

        function updateMarketData(data) {
            // Update market regime indicator
            const regimeEl = document.getElementById('market-regime');
            const regime = data.regime || 'unknown';

            regimeEl.className = `status-indicator regime-${regime}`;
            regimeEl.innerHTML = `<i class="fas fa-chart-line"></i> ${regime.charAt(0).toUpperCase() + regime.slice(1)}`;
        }

        function updatePerformanceCharts(data) {
            if (portfolioChart && data.portfolioHistory) {
                portfolioChart.data.labels = data.portfolioHistory.map(d => new Date(d.timestamp));
                portfolioChart.data.datasets[0].data = data.portfolioHistory.map(d => d.value);
                portfolioChart.update('none');
            }
        }

        function updateRecentTrades(trades) {
            const tbody = document.getElementById('recent-trades-table');

            if (trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            No recent trades
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = trades.slice(0, 10).map(trade => `
                <tr>
                    <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                    <td><strong>${trade.symbol}</strong></td>
                    <td><span class="badge bg-${trade.side === 'buy' ? 'success' : 'danger'}">${trade.side.toUpperCase()}</span></td>
                    <td>${trade.size.toFixed(4)}</td>
                    <td>$${trade.price.toLocaleString()}</td>
                    <td class="${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                        ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        function updateSystemStatus(data) {
            // Update system health indicator
            const healthEl = document.getElementById('system-health');
            const health = data.health || 'unknown';

            if (health === 'healthy') {
                healthEl.className = 'status-indicator status-online';
                healthEl.innerHTML = '<i class="fas fa-heartbeat"></i> Healthy';
            } else if (health === 'warning') {
                healthEl.className = 'status-indicator status-warning';
                healthEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Warning';
            } else {
                healthEl.className = 'status-indicator status-offline';
                healthEl.innerHTML = '<i class="fas fa-times-circle"></i> Issues';
            }
        }

        function updateTradingStatus(active) {
            const statusEl = document.getElementById('trading-status');
            if (active) {
                statusEl.textContent = 'Trading: Active';
                statusEl.className = 'badge bg-success';
            } else {
                statusEl.textContent = 'Trading: Stopped';
                statusEl.className = 'badge bg-secondary';
            }
        }

        function showAlert(message, type = 'info') {
            const alertEl = document.getElementById('alert-banner');
            const messageEl = document.getElementById('alert-message');

            messageEl.textContent = message;
            alertEl.className = `alert alert-${type} alert-dismissible fade show`;
            alertEl.classList.remove('d-none');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertEl.classList.add('d-none');
            }, 5000);
        }

        function sendCommand(command, params = {}) {
            return fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command, ...params })
            }).then(response => response.json());
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from nav links
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Add active class to clicked nav link
            event.target.classList.add('active');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            initializeCharts();
            setupEventListeners();
        });
    </script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 2px solid #ff6b35;
        }

        .card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #3d3d3d;
            border-bottom: 1px solid #555;
            color: #ff6b35;
            font-weight: bold;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #bbb;
            margin-top: 5px;
        }

        .status-online {
            color: #4CAF50;
        }

        .status-offline {
            color: #f44336;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
        }

        .table {
            color: #fff;
        }

        .table thead th {
            border-bottom: 2px solid #ff6b35;
            color: #ff6b35;
        }

        .price-up {
            color: #4CAF50;
        }

        .price-down {
            color: #f44336;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .log-info {
            color: #4CAF50;
        }

        .log-warning {
            color: #ff9800;
        }

        .log-error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-rocket text-gradient me-2"></i>
                <span class="text-gradient fw-bold">AsterAI HFT Trader</span>
                <span class="badge bg-primary ms-2">v2.0</span>
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active d-flex align-items-center" href="#overview" onclick="showTab('overview')">
                            <i class="fas fa-tachometer-alt me-2"></i>Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#trading" onclick="showTab('trading')">
                            <i class="fas fa-chart-line me-2"></i>Trading
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#ai-insights" onclick="showTab('ai-insights')">
                            <i class="fas fa-brain me-2"></i>AI Insights
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#risk" onclick="showTab('risk')">
                            <i class="fas fa-shield-alt me-2"></i>Risk Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#performance" onclick="showTab('performance')">
                            <i class="fas fa-chart-bar me-2"></i>Performance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#system" onclick="showTab('system')">
                            <i class="fas fa-cogs me-2"></i>System
                        </a>
                    </li>
                </ul>

                <div class="d-flex align-items-center gap-2">
                    <!-- Connection Status -->
                    <div class="status-indicator" id="connection-status">
                        <i class="fas fa-circle"></i>
                        <span>Live</span>
                    </div>

                    <!-- Market Regime -->
                    <div class="status-indicator" id="market-regime">
                        <i class="fas fa-chart-line"></i>
                        <span>Analyzing...</span>
                    </div>

                    <!-- System Health -->
                    <div class="status-indicator status-online" id="system-health">
                        <i class="fas fa-heartbeat"></i>
                        <span>Healthy</span>
                    </div>

                    <!-- Agent Selector -->
                    <select class="form-select form-select-sm" id="agent-selector" style="width: auto;">
                        <option value="hft">Conservative HFT</option>
                        <option value="degen">Degen Trading</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-4">
        <!-- Alert Banner for Important Messages -->
        <div id="alert-banner" class="alert alert-info alert-dismissible fade show d-none" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <span id="alert-message">System initialized successfully</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Tab Content -->
        <div id="overview-tab" class="tab-content active fade-in">
            <!-- Key Metrics Row -->
            <div class="row mb-4">
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="portfolio-value">$0.00</div>
                            <div class="metric-label">Portfolio Value</div>
                            <div class="mt-2">
                                <small class="text-muted" id="portfolio-change">+0.00 (0.00%)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="daily-pnl">$0.00</div>
                            <div class="metric-label">Daily P&L</div>
                            <div class="mt-2">
                                <small class="performance-indicator" id="pnl-indicator">
                                    <i class="fas fa-minus"></i> Neutral
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="win-rate">0.0%</div>
                            <div class="metric-label">Win Rate</div>
                            <div class="mt-2">
                                <small class="text-muted" id="total-trades">0 trades</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="sharpe-ratio">0.00</div>
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="mt-2">
                                <small class="text-muted">Risk-adjusted returns</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="max-drawdown">0.0%</div>
                            <div class="metric-label">Max Drawdown</div>
                            <div class="mt-2">
                                <small class="text-muted">Peak to trough</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="active-positions">0</div>
                            <div class="metric-label">Active Positions</div>
                            <div class="mt-2">
                                <small class="text-muted" id="position-details">No positions</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Analysis Row -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Portfolio Performance</h5>
                            <div class="chart-controls">
                                <button class="btn btn-sm btn-outline-primary" onclick="updateChartTimeframe('1H')">1H</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="updateChartTimeframe('1D')">1D</button>
                                <button class="btn btn-sm btn-outline-primary active" onclick="updateChartTimeframe('1W')">1W</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="updateChartTimeframe('1M')">1M</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="portfolio-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Insights</h5>
                        </div>
                        <div class="card-body">
                            <div id="ai-insights-container">
                                <div class="ai-insight">
                                    <div class="ai-insight-header">
                                        <i class="fas fa-robot"></i>
                                        <span class="fw-bold">Market Analysis</span>
                                        <span class="ai-confidence confidence-high">95% confidence</span>
                                    </div>
                                    <p class="mb-0 small">Strong bullish momentum detected in BTC/USD. Social sentiment analysis shows increased institutional interest.</p>
                                </div>

                                <div class="ai-insight">
                                    <div class="ai-insight-header">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span class="fw-bold">Risk Alert</span>
                                        <span class="ai-confidence confidence-medium">78% confidence</span>
                                    </div>
                                    <p class="mb-0 small">Volatility spike expected in ETH/USD. Consider reducing position sizes or implementing stop losses.</p>
                                </div>

                                <div class="ai-insight">
                                    <div class="ai-insight-header">
                                        <i class="fas fa-lightbulb"></i>
                                        <span class="fw-bold">Trading Opportunity</span>
                                        <span class="ai-confidence confidence-high">89% confidence</span>
                                    </div>
                                    <p class="mb-0 small">Statistical arbitrage opportunity detected between BTC/USD and ETH/USD pairs.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Activity and Market Overview Row -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Recent Trades</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Symbol</th>
                                            <th>Side</th>
                                            <th>Size</th>
                                            <th>Price</th>
                                            <th>P&L</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-trades-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                                No recent trades
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Market Overview</h5>
                        </div>
                        <div class="card-body">
                            <div id="market-overview">
                                <!-- Market data will be populated here -->
                                <div class="text-center py-4">
                                    <div class="loading-spinner mb-2"></div>
                                    <small class="text-muted">Loading market data...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-gamepad me-2"></i>Trading Controls</h5>
                            <div class="d-flex gap-2">
                                <span class="badge bg-success" id="trading-status">Trading: Active</span>
                                <span class="badge bg-info" id="strategy-mode">Mode: HFT Conservative</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <button id="start-trader" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-play"></i> Start Trading
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="stop-trader" class="btn btn-danger btn-lg w-100">
                                        <i class="fas fa-stop"></i> Stop Trading
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="refresh-data" class="btn btn-secondary btn-lg w-100">
                                        <i class="fas fa-sync"></i> Refresh Data
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center h-100">
                                        <small class="text-muted">
                                            Last update: <span id="last-update">Never</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="portfolio-value">$0.00</div>
                            <div class="metric-label">Portfolio Value</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="available-balance">$0.00</div>
                            <div class="metric-label">Available Balance</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="unrealized-pnl">$0.00</div>
                            <div class="metric-label">Unrealized P&L</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body metric-card">
                            <div class="metric-value" id="active-positions">0</div>
                            <div class="metric-label">Active Positions</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Market Data -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i> Market Data
                        </div>
                        <div class="card-body">
                            <div id="market-data" class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Price</th>
                                            <th>24h Change</th>
                                            <th>Volume</th>
                                            <th>Bid</th>
                                            <th>Ask</th>
                                        </tr>
                                    </thead>
                                    <tbody id="market-table-body">
                                        <!-- Market data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-area"></i> Portfolio Performance
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="performance-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- Risk Metrics -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-shield-alt"></i> Risk Metrics
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="sharpe-ratio">0.00</div>
                                        <div class="metric-label">Sharpe Ratio</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="max-drawdown">0.00%</div>
                                        <div class="metric-label">Max Drawdown</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="var-95">0.00%</div>
                                        <div class="metric-label">VaR 95%</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value" id="total-risk">0.00%</div>
                                        <div class="metric-label">Total Risk</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-terminal"></i> System Logs
                        </div>
                        <div class="card-body">
                            <div id="system-logs"
                                style="height: 250px; overflow-y: auto; background-color: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <!-- Logs will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Positions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list"></i> Active Positions & Grids
                        </div>
                        <div class="card-body">
                            <div id="positions-data">
                                <p class="text-muted">No active positions or grids</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Learning Tab -->
            <div id="adaptation-tab" class="tab-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-brain"></i> Real-Time Strategy Adaptation
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-lightbulb"></i>
                                            <strong>AI Learning Mode:</strong> System continuously adapts to current
                                            market conditions
                                            using real-time data. No historical backtesting needed.
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-chart-line"></i> Current Strategy Weights
                                                </h6>
                                                <div id="current-weights">
                                                    <p class="text-muted">Loading strategy weights...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-brain"></i> AI Learning Status
                                                </h6>
                                                <div id="learning-status">
                                                    <p class="text-muted">Monitoring AI adaptation...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button id="force-adaptation" class="btn btn-primary me-2">
                                            <i class="fas fa-sync"></i> Force Strategy Adaptation
                                        </button>
                                        <button id="reset-learning" class="btn btn-warning">
                                            <i class="fas fa-undo"></i> Reset Learning State
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Backtest Results -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line"></i> Backtest Results
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="backtest-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy Metrics -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-trophy"></i> Strategy Performance
                            </div>
                            <div class="card-body">
                                <div id="strategy-metrics">
                                    <p class="text-muted">Run a backtest to see results</p>
                                </div>
                            </div>
                        </div>

                        <!-- Strategy Recommendation -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-lightbulb"></i> AI Recommendation
                            </div>
                            <div class="card-body">
                                <div id="strategy-recommendation">
                                    <p class="text-muted">Compare strategies to get recommendations</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div id="positions-tab" class="tab-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list"></i> Open Positions Management
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button id="refresh-positions" class="btn btn-primary me-2">
                                            <i class="fas fa-sync"></i> Refresh Positions
                                        </button>
                                        <button id="close-all-positions" class="btn btn-danger">
                                            <i class="fas fa-times-circle"></i> Close All Positions
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div id="positions-summary" class="text-muted">
                                            Loading positions...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-table"></i> Current Positions
                            </div>
                            <div class="card-body">
                                <div id="positions-table" class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Side</th>
                                                <th>Size</th>
                                                <th>Entry Price</th>
                                                <th>Current Price</th>
                                                <th>P&L</th>
                                                <th>P&L %</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="positions-tbody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">Loading positions...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Global variables
            let websocket = null;
            let performanceChart = null;
            let backtestChart = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let currentTab = 'overview';

            // Initialize dashboard
            document.addEventListener('DOMContentLoaded', function () {
                initializeDashboard();
                setupEventListeners();
            });

            function initializeDashboard() {
                initializeCharts();
                connectWebSocket();
                loadInitialData();
                loadAdaptiveStatus();
            }

            function initializeCharts() {
                // Performance chart
                const perfCtx = document.getElementById('performance-chart').getContext('2d');
                performanceChart = new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Portfolio Value',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });

                // Backtest chart
                const backtestCtx = document.getElementById('backtest-chart').getContext('2d');
                backtestChart = new Chart(backtestCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Strategy Performance',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            function setupEventListeners() {
                // Overview tab events
                document.getElementById('start-trader').addEventListener('click', startTrader);
                document.getElementById('stop-trader').addEventListener('click', stopTrader);
                document.getElementById('refresh-data').addEventListener('click', loadInitialData);

                // Adaptation tab events
                document.getElementById('force-adaptation').addEventListener('click', forceAdaptation);
                document.getElementById('reset-learning').addEventListener('click', resetLearning);

                // Positions tab events
                document.getElementById('refresh-positions').addEventListener('click', refreshPositions);
                document.getElementById('close-all-positions').addEventListener('click', closeAllPositions);
            }

            function showTab(tabName) {
                // Hide all tabs
                const tabs = document.querySelectorAll('.tab-content');
                tabs.forEach(tab => tab.classList.remove('active'));

                // Show selected tab
                const selectedTab = document.getElementById(tabName + '-tab');
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // Update navigation
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));
                const activeLink = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }

                currentTab = tabName;

                // Load tab-specific data
                if (tabName === 'backtesting') {
                    // Could load backtest history here
                } else if (tabName === 'positions') {
                    refreshPositions();
                }
            }

            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/live-data`;

                websocket = new WebSocket(wsUrl);

                websocket.onopen = function (event) {
                    console.log('WebSocket connected');
                    document.getElementById('connection-status').className = 'badge bg-success';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle"></i> Connected';
                    reconnectAttempts = 0;
                };

                websocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                };

                websocket.onclose = function (event) {
                    console.log('WebSocket disconnected');
                    document.getElementById('connection-status').className = 'badge bg-danger';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                    attemptReconnect();
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('connection-status').className = 'badge bg-warning';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                };
            }

            function attemptReconnect() {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                }
            }

            async function loadInitialData() {
                try {
                    // Load market data
                    const marketResponse = await fetch('/api/market/data');
                    const marketData = await marketResponse.json();
                    updateMarketData(marketData);

                    // Load portfolio data
                    const portfolioResponse = await fetch('/api/portfolio/status');
                    const portfolioData = await portfolioResponse.json();
                    updatePortfolioData(portfolioData);

                    // Load risk metrics
                    const riskResponse = await fetch('/api/risk/metrics');
                    const riskData = await riskResponse.json();
                    updateRiskMetrics(riskData);

                    // Load performance history
                    const performanceResponse = await fetch('/api/performance/history?hours=24');
                    const performanceData = await performanceResponse.json();
                    updatePerformanceChart(performanceData);

                    // Load logs
                    const logsResponse = await fetch('/api/system/logs?lines=20');
                    const logsData = await logsResponse.json();
                    updateSystemLogs(logsData.logs);

                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

                } catch (error) {
                    console.error('Error loading initial data:', error);
                    addLogEntry('ERROR', 'Failed to load initial data: ' + error.message);
                }
            }

            function updateDashboard(data) {
                if (data.portfolio) updatePortfolioData(data.portfolio);
                if (data.market_data) updateMarketData(data.market_data);
                if (data.risk_metrics) updateRiskMetrics(data.risk_metrics);
                if (data.system_status) {
                    document.getElementById('system-status').textContent = data.system_status.toUpperCase();
                }
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            }

            function updateMarketData(data) {
                const tbody = document.getElementById('market-table-body');
                tbody.innerHTML = '';

                if (data.data) {
                    Object.entries(data.data).forEach(([symbol, symbolData]) => {
                        const row = document.createElement('tr');

                        let price = 'N/A';
                        let change = 'N/A';
                        let volume = 'N/A';
                        let bid = 'N/A';
                        let ask = 'N/A';

                        if (symbolData.ticker) {
                            const ticker = symbolData.ticker;
                            price = parseFloat(ticker.lastPrice || ticker.price || 0).toFixed(4);
                            change = parseFloat(ticker.priceChangePercent || 0).toFixed(2);
                            volume = parseFloat(ticker.volume || 0).toLocaleString();
                        }

                        if (symbolData.orderbook) {
                            const ob = symbolData.orderbook;
                            if (ob.bids && ob.bids.length > 0) {
                                bid = parseFloat(ob.bids[0][0]).toFixed(4);
                            }
                            if (ob.asks && ob.asks.length > 0) {
                                ask = parseFloat(ob.asks[0][0]).toFixed(4);
                            }
                        }

                        const changeClass = change !== 'N/A' && parseFloat(change) >= 0 ? 'price-up' : 'price-down';
                        const changeIcon = change !== 'N/A' && parseFloat(change) >= 0 ? 'â†‘' : 'â†“';

                        row.innerHTML = `
                        <td><strong>${symbol}</strong></td>
                        <td>$${price}</td>
                        <td class="${changeClass}">${changeIcon} ${change}%</td>
                        <td>${volume}</td>
                        <td>$${bid}</td>
                        <td>$${ask}</td>
                    `;

                        tbody.appendChild(row);
                    });
                }
            }

            function updatePortfolioData(data) {
                if (data.error) {
                    console.warn('Portfolio data error:', data.error);
                    return;
                }

                document.getElementById('portfolio-value').textContent = `$${data.total_balance.toLocaleString()}`;
                document.getElementById('available-balance').textContent = `$${data.available_balance.toLocaleString()}`;
                document.getElementById('unrealized-pnl').textContent = `$${data.unrealized_pnl.toLocaleString()}`;
                document.getElementById('active-positions').textContent = data.active_positions || 0;

                // Update positions display
                updatePositionsData(data);
            }

            function updatePositionsData(data) {
                const positionsDiv = document.getElementById('positions-data');

                if (data.active_positions > 0 && data.positions) {
                    let html = '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr>';
                    html += '<th>Symbol</th><th>Size</th><th>Entry Price</th><th>Current P&L</th>';
                    html += '</tr></thead><tbody>';

                    Object.entries(data.positions).forEach(([symbol, position]) => {
                        const pnlClass = position.unrealized_pnl >= 0 ? 'price-up' : 'price-down';
                        html += `<tr>
                        <td>${symbol}</td>
                        <td>${parseFloat(position.size || 0).toFixed(6)}</td>
                        <td>$${parseFloat(position.entry_price || 0).toFixed(4)}</td>
                        <td class="${pnlClass}">$${parseFloat(position.unrealized_pnl || 0).toFixed(2)}</td>
                    </tr>`;
                    });

                    html += '</tbody></table></div>';
                    positionsDiv.innerHTML = html;
                } else {
                    positionsDiv.innerHTML = '<p class="text-muted">No active positions</p>';
                }
            }

            function updateRiskMetrics(data) {
                if (data.error) {
                    console.warn('Risk metrics error:', data.error);
                    return;
                }

                document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
                document.getElementById('max-drawdown').textContent = `${(data.max_drawdown * 100).toFixed(2)}%`;
                document.getElementById('var-95').textContent = `${(data.var_95 * 100).toFixed(2)}%`;
                document.getElementById('total-risk').textContent = `${(data.total_risk * 100).toFixed(2)}%`;
            }

            function updatePerformanceChart(data) {
                if (!performanceChart || !data.timestamps || !data.portfolio_values) {
                    return;
                }

                // Format timestamps for display
                const labels = data.timestamps.map(ts => {
                    const date = new Date(ts);
                    return date.toLocaleTimeString();
                });

                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = data.portfolio_values;
                performanceChart.update();
            }

            function updateSystemLogs(logs) {
                const logsDiv = document.getElementById('system-logs');

                if (logs && logs.length > 0) {
                    logsDiv.innerHTML = logs.map(log => {
                        const levelClass = `log-${log.level.toLowerCase()}`;
                        return `<div class="log-entry ${levelClass}">
                        <small>${new Date(log.timestamp).toLocaleTimeString()}</small>
                        <strong>${log.level}</strong>: ${log.message}
                    </div>`;
                    }).join('');
                } else {
                    logsDiv.innerHTML = '<div class="log-entry log-info">System initialized successfully</div>';
                }

                // Auto-scroll to bottom
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }

            function addLogEntry(level, message) {
                const logsDiv = document.getElementById('system-logs');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level.toLowerCase()}`;
                logEntry.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small>
                <strong>${level}</strong>: ${message}
            `;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }

            async function startTrader() {
                try {
                    const response = await fetch('/api/trader/start', { method: 'POST' });
                    const result = await response.json();

                    if (result.status === 'starting') {
                        addLogEntry('INFO', 'Starting autonomous trader...');
                        document.getElementById('system-status').textContent = 'STARTING';
                        document.getElementById('system-status').className = 'badge bg-warning';
                    } else if (result.error) {
                        addLogEntry('ERROR', 'Failed to start trader: ' + result.error);
                    }
                } catch (error) {
                    addLogEntry('ERROR', 'Failed to start trader: ' + error.message);
                }
            }

            async function runBacktest() {
                const strategy = document.getElementById('backtest-strategy').value;
                const days = document.getElementById('backtest-days').value;
                const symbol = document.getElementById('backtest-symbol').value;

                try {
                    addLogEntry('INFO', `Running ${strategy} backtest for ${symbol} (${days} days)...`);

                    const response = await fetch(`/api/backtest/run?strategy=${strategy}&days=${days}&symbol=${symbol}`);
                    const result = await response.json();

                    if (result.error) {
                        addLogEntry('ERROR', 'Backtest failed: ' + result.error);
                        return;
                    }

                    // Update chart
                    updateBacktestChart(result);

                    // Update metrics
                    updateStrategyMetrics(result);

                    addLogEntry('SUCCESS', `Backtest completed: ${result.total_return.toFixed(2)}% return, Sharpe: ${result.sharpe_ratio.toFixed(2)}`);

                } catch (error) {
                    addLogEntry('ERROR', 'Backtest failed: ' + error.message);
                }
            }

            async function compareStrategies() {
                const days = document.getElementById('backtest-days').value;
                const symbol = document.getElementById('backtest-symbol').value;

                try {
                    addLogEntry('INFO', `Comparing all strategies for ${symbol} (${days} days)...`);

                    const response = await fetch(`/api/backtest/compare?days=${days}&symbol=${symbol}`);
                    const results = await response.json();

                    if (results.error) {
                        addLogEntry('ERROR', 'Strategy comparison failed: ' + results.error);
                        return;
                    }

                    // Update recommendation
                    if (results.recommendation) {
                        const rec = results.recommendation;
                        document.getElementById('strategy-recommendation').innerHTML = `
                        <h5 class="text-warning">${rec.best_strategy.toUpperCase()}</h5>
                        <p>Sharpe Ratio: ${rec.sharpe_ratio.toFixed(2)}</p>
                        <p class="text-muted">${rec.reason}</p>
                    `;
                    }

                    // Update metrics comparison
                    updateStrategyComparison(results);

                    addLogEntry('SUCCESS', 'Strategy comparison completed');

                } catch (error) {
                    addLogEntry('ERROR', 'Strategy comparison failed: ' + error.message);
                }
            }

            async function forceAdaptation() {
                try {
                    addLogEntry('INFO', 'Forcing strategy adaptation based on current market conditions...');

                    const response = await fetch('/api/adaptive/adapt', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        addLogEntry('SUCCESS', 'Strategy adaptation completed');
                        // Refresh the strategy weights display
                        loadAdaptiveStatus();
                    } else {
                        addLogEntry('ERROR', 'Strategy adaptation failed: ' + (result.error || 'Unknown error'));
                    }

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to force adaptation: ' + error.message);
                }
            }

            async function resetLearning() {
                if (!confirm('Are you sure you want to reset the AI learning state? This will clear all learned patterns.')) {
                    return;
                }

                try {
                    addLogEntry('WARNING', 'Resetting AI learning state...');

                    const response = await fetch('/api/adaptive/reset', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        addLogEntry('SUCCESS', 'AI learning state reset');
                        // Refresh displays
                        loadAdaptiveStatus();
                    } else {
                        addLogEntry('ERROR', 'Reset failed: ' + (result.error || 'Unknown error'));
                    }

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to reset learning: ' + error.message);
                }
            }

            async function loadAdaptiveStatus() {
                try {
                    const response = await fetch('/api/adaptive/status');
                    const status = await response.json();

                    // Update strategy weights
                    const weightsDiv = document.getElementById('current-weights');
                    if (status.strategy_weights) {
                        let weightsHtml = '';
                        for (const [strategy, weight] of Object.entries(status.strategy_weights)) {
                            const percentage = (weight * 100).toFixed(1);
                            weightsHtml += `
                            <div class="d-flex justify-content-between mb-1">
                                <span>${strategy.charAt(0).toUpperCase() + strategy.slice(1)}:</span>
                                <span class="badge bg-primary">${percentage}%</span>
                            </div>
                        `;
                        }
                        weightsDiv.innerHTML = weightsHtml;
                    }

                    // Update learning status
                    const learningDiv = document.getElementById('learning-status');
                    learningDiv.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Samples Learned</small>
                            <div class="h5 mb-0">${status.learning_samples || 0}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Model Accuracy</small>
                            <div class="h5 mb-0">${status.model_accuracy ? (status.model_accuracy * 100).toFixed(1) : 0}%</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Active Strategies: ${status.active_strategies ? status.active_strategies.length : 0}</small>
                    </div>
                `;

                } catch (error) {
                    console.error('Failed to load adaptive status:', error);
                }
            }

            async function refreshPositions() {
                try {
                    const response = await fetch('/api/positions/open');
                    const data = await response.json();

                    updatePositionsTable(data.positions || []);
                    updatePositionsSummary(data.positions || []);

                } catch (error) {
                    addLogEntry('ERROR', 'Failed to refresh positions: ' + error.message);
                }
            }

            async function closeAllPositions() {
                if (!confirm('Are you sure you want to close ALL positions? This action cannot be undone.')) {
                    return;
                }

                addLogEntry('WARNING', 'Closing all positions...');

                // This would close all positions
                // For now, just show a message
                addLogEntry('INFO', 'All positions close request submitted');
            }

            async function stopTrader() {
                try {
                    const response = await fetch('/api/trader/stop', { method: 'POST' });
                    const result = await response.json();

                    if (result.status === 'stopped') {
                        addLogEntry('INFO', 'Stopping autonomous trader...');
                        document.getElementById('system-status').textContent = 'STOPPED';
                        document.getElementById('system-status').className = 'badge bg-secondary';
                    } else if (result.error) {
                        addLogEntry('ERROR', 'Failed to stop trader: ' + result.error);
                    }
                } catch (error) {
                    addLogEntry('ERROR', 'Failed to stop trader: ' + error.message);
                }
            }

            // Auto-refresh every 30 seconds as backup
            setInterval(loadInitialData, 30000);
        </script>
</body>

</html>