<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AsterAI - Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    <style>
        .analytics-card {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            border: none;
            border-radius: 15px;
        }

        .backtest-controls {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .strategy-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .strategy-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .strategy-card:hover {
            transform: translateY(-3px);
        }

        .strategy-best {
            border: 2px solid #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .performance-metric {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-positive {
            color: #28a745;
        }

        .metric-negative {
            color: #dc3545;
        }

        .backtest-chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-bar"></i> AsterAI - Analytics
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Market Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ai-learning">AI Learning</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/positions">Positions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analytics">Analytics</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button id="run-backtest" class="btn btn-outline-light me-2">
                        <i class="fas fa-play"></i> Run Backtest
                    </button>
                    <button id="compare-strategies" class="btn btn-outline-primary">
                        <i class="fas fa-balance-scale"></i> Compare All
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Analytics Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="analytics-card card text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="card-title">
                                    <i class="fas fa-analytics"></i> Advanced Trading Analytics
                                </h2>
                                <p class="card-text">Backtesting, strategy comparison, and performance analysis</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="h4 mb-0" id="last-backtest">Never</div>
                                <small class="text-muted">Last Backtest</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtest Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card analytics-card text-white">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Backtest Configuration
                    </div>
                    <div class="card-body">
                        <div class="backtest-controls">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Strategy</label>
                                    <select class="form-select" id="backtest-strategy">
                                        <option value="barbell">Barbell Portfolio</option>
                                        <option value="asymmetric">Asymmetric Bets</option>
                                        <option value="tail_risk">Tail Risk Hedging</option>
                                        <option value="all">All Strategies</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Time Period</label>
                                    <select class="form-select" id="backtest-days">
                                        <option value="7">7 Days</option>
                                        <option value="30">30 Days</option>
                                        <option value="90">90 Days</option>
                                        <option value="180">180 Days</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Primary Asset</label>
                                    <select class="form-select" id="backtest-symbol">
                                        <option value="BTCUSDT">Bitcoin (BTC)</option>
                                        <option value="ETHUSDT">Ethereum (ETH)</option>
                                        <option value="SOLUSDT">Solana (SOL)</option>
                                        <option value="ADAUSDT">Cardano (ADA)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Initial Balance</label>
                                    <input type="number" class="form-control" id="initial-balance" value="10000" min="1000" max="100000">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button id="run-backtest-btn" class="btn btn-primary w-100">
                                        <i class="fas fa-play"></i> Run Backtest
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Comparison -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card analytics-card text-white">
                    <div class="card-header">
                        <i class="fas fa-balance-scale"></i> Strategy Performance Comparison
                    </div>
                    <div class="card-body">
                        <div class="strategy-comparison" id="strategy-comparison">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-chart-bar fa-2x mb-3"></i>
                                <p>Run backtests to compare strategy performance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtest Results Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card analytics-card text-white">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Backtest Results
                    </div>
                    <div class="card-body">
                        <div class="backtest-chart-container">
                            <canvas id="backtest-chart" width="800" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card analytics-card text-white">
                    <div class="card-body text-center">
                        <div class="performance-metric" id="total-return">0.00%</div>
                        <small class="text-muted">Total Return</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card text-white">
                    <div class="card-body text-center">
                        <div class="performance-metric" id="sharpe-ratio">0.00</div>
                        <small class="text-muted">Sharpe Ratio</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card text-white">
                    <div class="card-body text-center">
                        <div class="performance-metric" id="max-drawdown">0.00%</div>
                        <small class="text-muted">Max Drawdown</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card text-white">
                    <div class="card-body text-center">
                        <div class="performance-metric" id="win-rate">0.00%</div>
                        <small class="text-muted">Win Rate</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Table -->
        <div class="row">
            <div class="col-12">
                <div class="card analytics-card text-white">
                    <div class="card-header">
                        <i class="fas fa-table"></i> Detailed Performance Metrics
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody id="metrics-table">
                                    <tr>
                                        <td>Total Trades</td>
                                        <td id="total-trades">0</td>
                                        <td>Number of completed trades</td>
                                    </tr>
                                    <tr>
                                        <td>Winning Trades</td>
                                        <td id="winning-trades">0</td>
                                        <td>Number of profitable trades</td>
                                    </tr>
                                    <tr>
                                        <td>Lossing Trades</td>
                                        <td id="losing-trades">0</td>
                                        <td>Number of losing trades</td>
                                    </tr>
                                    <tr>
                                        <td>Avg Trade Return</td>
                                        <td id="avg-trade-return">0.00%</td>
                                        <td>Average return per trade</td>
                                    </tr>
                                    <tr>
                                        <td>Best Trade</td>
                                        <td id="best-trade">0.00%</td>
                                        <td>Best single trade return</td>
                                    </tr>
                                    <tr>
                                        <td>Worst Trade</td>
                                        <td id="worst-trade">0.00%</td>
                                        <td>Worst single trade return</td>
                                    </tr>
                                    <tr>
                                        <td>Profit Factor</td>
                                        <td id="profit-factor">0.00</td>
                                        <td>Gross profit / Gross loss</td>
                                    </tr>
                                    <tr>
                                        <td>Calmar Ratio</td>
                                        <td id="calmar-ratio">0.00</td>
                                        <td>Annual return / Max drawdown</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let backtestChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadBacktestHistory();

            // Event listeners
            document.getElementById('run-backtest-btn').addEventListener('click', runBacktest);
            document.getElementById('compare-strategies').addEventListener('click', compareStrategies);
        });

        function initializeCharts() {
            const ctx = document.getElementById('backtest-chart').getContext('2d');
            backtestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#17a2b8',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'white' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'white' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    }
                }
            });
        }

        function runBacktest() {
            const strategy = document.getElementById('backtest-strategy').value;
            const days = document.getElementById('backtest-days').value;
            const symbol = document.getElementById('backtest-symbol').value;
            const balance = document.getElementById('initial-balance').value;

            showLoading('Running backtest...');

            fetch(`/api/backtest/run?strategy=${strategy}&days=${days}&symbol=${symbol}&balance=${balance}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.error) {
                        showAlert('Backtest failed: ' + data.error, 'danger');
                        return;
                    }
                    updateBacktestResults(data);
                    showAlert(`Backtest completed! Total return: ${data.total_return.toFixed(2)}%`, 'success');
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Backtest failed: ' + error.message, 'danger');
                });
        }

        function compareStrategies() {
            const days = document.getElementById('backtest-days').value;
            const symbol = document.getElementById('backtest-symbol').value;
            const balance = document.getElementById('initial-balance').value;

            showLoading('Comparing all strategies...');

            fetch(`/api/backtest/compare?days=${days}&symbol=${symbol}&balance=${balance}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.error) {
                        showAlert('Strategy comparison failed: ' + data.error, 'danger');
                        return;
                    }
                    updateStrategyComparison(data);
                    showAlert('Strategy comparison completed!', 'success');
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Strategy comparison failed: ' + error.message, 'danger');
                });
        }

        function updateBacktestResults(data) {
            // Update performance metrics
            document.getElementById('total-return').textContent = `${data.total_return.toFixed(2)}%`;
            document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
            document.getElementById('max-drawdown').textContent = `${(data.max_drawdown * 100).toFixed(2)}%`;
            document.getElementById('win-rate').textContent = `${(data.win_rate * 100).toFixed(1)}%`;

            // Update detailed metrics
            document.getElementById('total-trades').textContent = data.total_trades;
            document.getElementById('winning-trades').textContent = data.winning_trades;
            document.getElementById('losing-trades').textContent = data.total_trades - data.winning_trades;
            document.getElementById('avg-trade-return').textContent = `${data.avg_trade_return.toFixed(2)}%`;
            document.getElementById('best-trade').textContent = `${data.best_trade.toFixed(2)}%`;
            document.getElementById('worst-trade').textContent = `${data.worst_trade.toFixed(2)}%`;
            document.getElementById('profit-factor').textContent = data.profit_factor.toFixed(2);
            document.getElementById('calmar-ratio').textContent = data.calmar_ratio.toFixed(2);

            // Update chart
            if (data.portfolio_history && backtestChart) {
                const timestamps = data.portfolio_history.map(h => new Date(h.timestamp).toLocaleDateString());
                const values = data.portfolio_history.map(h => h.value);

                backtestChart.data.labels = timestamps;
                backtestChart.data.datasets[0].data = values;
                backtestChart.update();
            }

            // Update last backtest time
            document.getElementById('last-backtest').textContent = new Date().toLocaleString();
        }

        function updateStrategyComparison(data) {
            const container = document.getElementById('strategy-comparison');
            container.innerHTML = '';

            if (data.strategies) {
                Object.entries(data.strategies).forEach(([strategyName, strategyData]) => {
                    const isBest = data.recommendation && data.recommendation.best_strategy === strategyName;
                    const cardClass = `strategy-card ${isBest ? 'strategy-best' : ''}`;

                    const returnClass = strategyData.total_return >= 0 ? 'metric-positive' : 'metric-negative';

                    container.innerHTML += `
                        <div class="${cardClass}">
                            <h6>${strategyName.charAt(0).toUpperCase() + strategyName.slice(1)}</h6>
                            <div class="performance-metric ${returnClass}">
                                ${strategyData.total_return.toFixed(2)}%
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small>Sharpe: ${strategyData.sharpe_ratio.toFixed(2)}</small>
                                </div>
                                <div class="col-6">
                                    <small>Win Rate: ${(strategyData.win_rate * 100).toFixed(1)}%</small>
                                </div>
                            </div>
                            ${isBest ? '<div class="mt-2"><span class="badge bg-warning">🏆 Best Strategy</span></div>' : ''}
                        </div>
                    `;
                });
            }

            if (data.recommendation) {
                const rec = data.recommendation;
                showAlert(`Recommended: ${rec.best_strategy.toUpperCase()} (Sharpe: ${rec.sharpe_ratio.toFixed(2)})`, 'info');
            }
        }

        function loadBacktestHistory() {
            fetch('/api/backtest/history')
                .then(response => response.json())
                .then(data => {
                    if (data.backtests && data.backtests.length > 0) {
                        const latest = data.backtests[data.backtests.length - 1];
                        updateBacktestResults(latest);
                    }
                })
                .catch(error => console.error('Error loading backtest history:', error));
        }

        function showLoading(message) {
            // Simple loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.className = 'position-fixed w-100 h-100 d-flex align-items-center justify-content-center';
            loadingDiv.style.cssText = 'top: 0; left: 0; background: rgba(0,0,0,0.8); z-index: 9999;';
            loadingDiv.innerHTML = `
                <div class="text-center text-white">
                    <div class="spinner-border mb-3" role="status"></div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading-overlay');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Auto-refresh every 60 seconds
        setInterval(loadBacktestHistory, 60000);
    </script>
</body>

</html>


